<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>文章｜我的網站</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{--ink:#0b1220;--bg:#ffffff}
    @media (prefers-color-scheme: dark){
      :root{--ink:#e5e7eb;--bg:#0b1020}
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
         color:var(--ink);background:var(--bg)}
    header{padding:16px 20px;border-bottom:1px solid #e5e7eb}
    h1{margin:0;font-size:22px}
    main{max-width:1100px;margin:0 auto;padding:20px}
    /* 卡片樣式（也會由腳本再補一次，這裡先保底） */
    .feed{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin:16px 0}
    .post{background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    .post img{width:100%;display:block;aspect-ratio:4/3;object-fit:cover}
    .post .meta{display:flex;justify-content:space-between;gap:8px;padding:8px 12px;font-size:.875rem;color:#475569}
    .post .submeta{padding:0 12px 8px;color:#64748b;font-size:.85rem}
    .post .msg{padding:0 12px 12px;line-height:1.6}
    @media (prefers-color-scheme: dark){
      .post{background:#0b1220;border-color:#1f2937;color:#e5e7eb}
      .post .meta,.post .submeta{color:#9aa4b2}
    }
    a.link{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <h1>文章</h1>
  </header>

  <main>
    <!-- 貼文容器 -->
    <section id="feed" class="feed"></section>
  </main>

  <script>
  (async function boot(){
    const box = document.getElementById('feed');
    box.innerHTML = '載入中…';

    // 嘗試抓 ./assets/posts.json；404 時退到 ./Bruce/assets/posts.json
    async function fetchJSON(path){
      const res = await fetch(path + '?v=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status + ' at ' + path);
      return res.json();
    }

    let data;
    try {
      data = await fetchJSON('assets/posts.json');           // 你現在的專案結構，這個路徑應該就會成功
    } catch(e1){
      try {
        data = await fetchJSON('Bruce/assets/posts.json');   // 後備：若你的網站根目錄需要帶 Bruce/
      } catch(e2){
        console.error(e1, e2);
        box.innerHTML = '<p>讀取失敗（找不到 posts.json）。請確認路徑在 <code>assets/posts.json</code> 或 <code>Bruce/assets/posts.json</code>。</p>';
        return;
      }
    }

    // 兼容兩種格式：[{...}] 或 {items:[...]}
    const posts = Array.isArray(data) ? data : (data.items || []);
    if (!Array.isArray(posts)) {
      console.error('posts.json 內容不是陣列或 items 陣列：', data);
      box.innerHTML = '<p>posts.json 格式錯誤：需要陣列或 {items:[...]}</p>';
      return;
    }

    // 時間新到舊
    posts.sort((a,b)=> new Date(b.time) - new Date(a.time));

    // 渲染
    const html = posts.map(p => {
      const img = p.image ? `<a href="${p.url||'#'}" target="_blank" rel="noopener">
        <img src="${p.image}" alt="" loading="lazy"></a>` : '';
      const feel = p.feeling ? `｜心情：${p.feeling}` : '';
      const place = p.place ? `｜地點：${p.place}` : '';
      const when = new Date(p.time);
      const time = isNaN(when) ? (p.time||'') : when.toLocaleString('zh-TW',{hour12:false});
      const msg = (p.message||'')
        .replace(/(https?:\/\/[^\s]+)/g, u=>`<a href="${u}" target="_blank" rel="noopener">${u}</a>`)
        .replace(/\n/g,'<br>');
      const link = p.url ? `<a class="link" href="${p.url}" target="_blank" rel="noopener">在 Facebook 查看</a>` : '';
      return `
        <article class="post">
          ${img}
          <div class="meta">
            <time>${time}</time>
            ${link}
          </div>
          <div class="submeta">${[feel, place].filter(Boolean).join(' ')}</div>
          <p class="msg">${msg}</p>
        </article>
      `;
    }).join('');

    box.innerHTML = html || '<p>目前沒有貼文。</p>';
  })();
  </script>
</body>
</html>
