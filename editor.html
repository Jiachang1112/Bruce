<!doctype html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ç¶²ç«™å¾Œå°ç·¨è¼¯å™¨</title>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <style>
    /* å¾Œå°å°ˆç”¨æ¨£å¼ */
    body { padding-bottom: 100px; }
    .editor-container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; align-items: start; }
    .sidebar { height: calc(100vh - 100px); overflow-y: auto; background: var(--bg-card); border: 1px solid var(--line); border-radius: 12px; padding: 10px; }
    .post-item { padding: 10px; border-bottom: 1px solid var(--line); cursor: pointer; font-size: 0.9rem; }
    .post-item:hover { background: rgba(255,255,255,0.05); }
    .post-item.active { background: var(--brand); color: #fff; border-radius: 6px; }
    
    .form-panel { background: var(--bg-card); border: 1px solid var(--line); border-radius: 16px; padding: 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; margin-bottom: 6px; opacity: 0.8; font-weight: bold; }
    .form-group input, .form-group textarea, .form-group select { 
      width: 100%; padding: 10px; border-radius: 8px; 
      border: 1px solid var(--line); background: var(--bg); color: var(--ink);
      font-family: inherit;
    }
    .form-group textarea { height: 150px; resize: vertical; }
    
    .actions { display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--line); }
    .btn-success { background: #10b981 !important; color: white !important; border: none; cursor: pointer;}
    .btn-danger { background: #ef4444 !important; color: white !important; border: none; cursor: pointer;}
    .btn-copy { background: #f59e0b !important; color: white !important; width: 100%; justify-content: center; font-size: 1.2rem; padding: 15px;}

    .output-area { margin-top: 30px; padding: 20px; background: #000; border-radius: 12px; border: 1px solid #333; display: none; }
    .output-area textarea { width: 100%; height: 200px; background: #111; color: #0f0; font-family: monospace; border: none; margin-top: 10px;}
    
    @media(max-width: 768px) {
      .editor-container { grid-template-columns: 1fr; }
      .sidebar { height: 200px; }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="container wrap">
      <a class="brand" href="index.html"><b>ç¶²ç«™å¾Œå°ç·¨è¼¯å™¨</b></a>
      <div class="right">
        <a href="posts.html" target="_blank">é è¦½ç¶²ç«™ â†—</a>
      </div>
    </div>
  </nav>

  <main class="container section">
    <div class="card" style="margin-bottom: 20px; background: #1e293b; border-color: #334155;">
      <h3 style="margin-top:0">ä½¿ç”¨èªªæ˜</h3>
      <ol style="margin-bottom:0; padding-left: 20px; opacity: 0.9;">
        <li>åœ¨å·¦å´é¸æ“‡æ–‡ç« é€²è¡Œä¿®æ”¹ï¼Œæˆ–é»æ“Šã€Œï¼‹ æ–°å¢æ–‡ç« ã€ã€‚</li>
        <li>å¡«å¯«å³å´è¡¨å–®ï¼ˆç…§ç‰‡è«‹å¡«å…¥ `images/æª”å.jpg`ï¼‰ã€‚</li>
        <li>ç·¨è¼¯å®Œæˆå¾Œï¼Œå‹™å¿…æŒ‰ä¸‹ **ã€Œæ›´æ–°/å„²å­˜æ­¤æ–‡ç« ã€**ã€‚</li>
        <li>å…¨éƒ¨æ”¹å¥½å¾Œï¼ŒæŒ‰æœ€ä¸‹æ–¹çš„æ©˜è‰²æŒ‰éˆ• **ã€Œè¤‡è£½å®Œæ•´ç¨‹å¼ç¢¼ã€**ã€‚</li>
        <li>å›åˆ° GitHubï¼Œæ‰“é–‹ `assets/js/posts.json`ï¼Œå…¨é¸è²¼ä¸Šå³å¯ï¼</li>
      </ol>
    </div>

    <div class="editor-container">
      <div class="sidebar">
        <div class="post-item" onclick="createNew()" style="font-weight:bold; color: var(--brand2); text-align:center; border:1px dashed var(--line); margin-bottom:10px;">ï¼‹ æ–°å¢æ–‡ç« </div>
        <div id="postList">è¼‰å…¥ä¸­...</div>
      </div>

      <div class="form-panel">
        <div class="form-group">
          <label>æ–‡ç«  ID (è‹±æ–‡ä»£è™Ÿï¼Œä¸å¯é‡è¤‡)</label>
          <input type="text" id="p_id" placeholder="ä¾‹å¦‚ï¼š2025-01-01-new-year">
        </div>
        <div class="form-group">
          <label>æ¨™é¡Œ (Title)</label>
          <input type="text" id="p_title" placeholder="ä¾‹å¦‚ï¼š2025å¹´1æœˆ1æ—¥ - å°åŒ—è·¨å¹´">
        </div>
        <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
          <div>
            <label>æ—¥æœŸ (Date)</label>
            <input type="date" id="p_date_input">
          </div>
          <div>
            <label>æ™‚é–“ (Time)</label>
            <input type="time" id="p_time_input">
          </div>
        </div>
        <div class="form-group">
          <label>åœ°é» (Place)</label>
          <input type="text" id="p_place" placeholder="ä¾‹å¦‚ï¼šè·¯ç«¹å€">
        </div>
        <div class="form-group">
          <label>å¿ƒæƒ… (Feeling)</label>
          <input type="text" id="p_feeling" placeholder="ä¾‹å¦‚ï¼šè¦ºå¾—é–‹å¿ƒ">
        </div>
        <div class="form-group">
          <label>ç…§ç‰‡è·¯å¾‘ (Image)</label>
          <input type="text" id="p_image" placeholder="images/ä½ çš„ç…§ç‰‡.jpg">
          <small style="opacity:0.6">è«‹ç¢ºèªç…§ç‰‡å·²ä¸Šå‚³åˆ° images/ è³‡æ–™å¤¾</small>
        </div>
        <div class="form-group">
          <label>æ–‡ç« å…§å®¹ (Message)</label>
          <textarea id="p_message" placeholder="è«‹è¼¸å…¥å…§æ–‡..."></textarea>
        </div>
        
        <div class="actions">
          <button class="btn btn-success" style="flex:2" onclick="saveCurrentPost()">ğŸ’¾ æ›´æ–°/å„²å­˜æ­¤æ–‡ç« </button>
          <button class="btn btn-danger" onclick="deleteCurrentPost()">ğŸ—‘ï¸ åˆªé™¤</button>
        </div>
      </div>
    </div>

    <div style="margin-top: 40px;">
      <button class="btn btn-copy" onclick="generateJSON()">ğŸ“‹ è¤‡è£½å®Œæ•´ç¨‹å¼ç¢¼ (æº–å‚™è²¼å› GitHub)</button>
      <p id="copyTip" style="text-align:center; margin-top:10px; color:#10b981; display:none;">âœ… å·²è¤‡è£½ï¼è«‹å» GitHub çš„ posts.json è²¼ä¸Šã€‚</p>
    </div>

    <div id="output" class="output-area">
      <p>é€™æ˜¯ç”¢ç”Ÿå‡ºä¾†çš„ç¨‹å¼ç¢¼ (å¦‚æœä¸æ–¹ä¾¿è¤‡è£½ï¼Œå¯ä»¥æ‰‹å‹•è¤‡è£½é€™è£¡)ï¼š</p>
      <textarea id="jsonOutput"></textarea>
    </div>

  </main>

  <script>
  let allPosts = [];
  let currentId = null;

  // 1. å•Ÿå‹•æ™‚è®€å–ç¾æœ‰çš„ posts.json
  async function init() {
    try {
      // å˜—è©¦æŠ“å–ç¶²è·¯ä¸Šæˆ–æœ¬åœ°çš„ posts.json
      const res = await fetch('assets/js/posts.json?v=' + Date.now());
      const data = await res.json();
      if (data.items) {
        allPosts = data.items;
      } else if (Array.isArray(data)) {
        allPosts = data;
      }
      renderList();
      // é è¨­é¸å–ç¬¬ä¸€ç¯‡
      if(allPosts.length > 0) loadPost(0);
    } catch (e) {
      document.getElementById('postList').innerHTML = '<p style="padding:10px; color:red">è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª assets/js/posts.json å­˜åœ¨ã€‚</p>';
      console.error(e);
    }
  }

  // 2. æ¸²æŸ“å·¦å´åˆ—è¡¨
  function renderList() {
    const listEl = document.getElementById('postList');
    listEl.innerHTML = '';
    
    // ä¾ç…§æ™‚é–“æ’åº (æ–° -> èˆŠ)
    allPosts.sort((a, b) => new Date(b.time) - new Date(a.time));

    allPosts.forEach((p, index) => {
      const div = document.createElement('div');
      div.className = `post-item ${p.id === currentId ? 'active' : ''}`;
      // é¡¯ç¤ºæ¨™é¡Œæˆ–æ—¥æœŸ
      div.textContent = p.title || p.time.split('T')[0];
      div.onclick = () => loadPost(index);
      listEl.appendChild(div);
    });
  }

  // 3. è®€å–å–®ä¸€æ–‡ç« åˆ°è¡¨å–®
  function loadPost(index) {
    const p = allPosts[index];
    currentId = p.id;
    
    document.getElementById('p_id').value = p.id || '';
    document.getElementById('p_title').value = p.title || '';
    document.getElementById('p_place').value = p.place || '';
    document.getElementById('p_feeling').value = p.feeling || '';
    document.getElementById('p_image').value = p.image || '';
    document.getElementById('p_message').value = p.message || '';

    // è™•ç†æ—¥æœŸæ™‚é–“æ ¼å¼ ISO è½‰ input
    if(p.time) {
      const d = new Date(p.time);
      // è½‰æˆ YYYY-MM-DD
      const dateStr = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
      // è½‰æˆ HH:mm
      const timeStr = String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0');
      
      document.getElementById('p_date_input').value = dateStr;
      document.getElementById('p_time_input').value = timeStr;
    }

    renderList(); // æ›´æ–°é¸å–ç‹€æ…‹
  }

  // 4. æ¸…ç©ºè¡¨å–® (æ–°å¢æ¨¡å¼)
  function createNew() {
    currentId = null;
    // è‡ªå‹•ç”Ÿæˆä»Šå¤©çš„ ID
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0];
    
    document.getElementById('p_id').value = `${dateStr}-new-post`;
    document.getElementById('p_title').value = `${today.getFullYear()}å¹´${today.getMonth()+1}æœˆ${today.getDate()}æ—¥ - `;
    document.getElementById('p_place').value = '';
    document.getElementById('p_feeling').value = '';
    document.getElementById('p_image').value = 'images/';
    document.getElementById('p_message').value = '';
    
    document.getElementById('p_date_input').value = dateStr;
    document.getElementById('p_time_input').value = "12:00";
    
    // ç§»é™¤åˆ—è¡¨é¸å–ç‹€æ…‹
    document.querySelectorAll('.post-item').forEach(el => el.classList.remove('active'));
  }

  // 5. å„²å­˜/æ›´æ–°è¨˜æ†¶é«”ä¸­çš„æ–‡ç« 
  function saveCurrentPost() {
    const id = document.getElementById('p_id').value;
    if(!id) { alert('è«‹è¼¸å…¥æ–‡ç«  ID'); return; }

    // çµ„åˆæ—¥æœŸæ™‚é–“
    const dInput = document.getElementById('p_date_input').value;
    const tInput = document.getElementById('p_time_input').value;
    const fullTime = `${dInput}T${tInput}:00+08:00`;

    const newPost = {
      id: id,
      title: document.getElementById('p_title').value,
      time: fullTime,
      place: document.getElementById('p_place').value,
      feeling: document.getElementById('p_feeling').value,
      image: document.getElementById('p_image').value,
      message: document.getElementById('p_message').value,
      url: "#" // é è¨­
    };

    // æª¢æŸ¥æ˜¯æ–°å¢é‚„æ˜¯ä¿®æ”¹
    const existingIndex = allPosts.findIndex(p => p.id === currentId); // æ‰¾èˆŠ ID
    
    if (existingIndex >= 0) {
      // æ›´æ–°
      allPosts[existingIndex] = newPost;
      alert('æ–‡ç« å·²æ›´æ–°ï¼(è¨˜å¾—æœ€å¾Œè¦æŒ‰è¤‡è£½ç¨‹å¼ç¢¼)');
    } else {
      // æª¢æŸ¥æ–° ID æ˜¯å¦é‡è¤‡
      if(allPosts.find(p => p.id === id)) {
        // ID é‡è¤‡ï¼Œè¦†è“‹å®ƒ
        const idx = allPosts.findIndex(p => p.id === id);
        allPosts[idx] = newPost;
        alert('ID é‡è¤‡ï¼Œå·²è¦†è“‹èˆŠæ–‡ç« ã€‚');
      } else {
        // çœŸæ–°å¢
        allPosts.unshift(newPost); // åŠ åˆ°æœ€å‰é¢
        alert('æ–°æ–‡ç« å·²åŠ å…¥åˆ—è¡¨ï¼');
      }
    }
    
    currentId = id;
    renderList();
  }

  // 6. åˆªé™¤
  function deleteCurrentPost() {
    if(!currentId) return;
    if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ–‡ç« å—ï¼Ÿ')) return;
    allPosts = allPosts.filter(p => p.id !== currentId);
    renderList();
    if(allPosts.length > 0) loadPost(0);
    else createNew();
  }

  // 7. ç”¢ç”Ÿä¸¦è¤‡è£½ JSON
  function generateJSON() {
    const finalObj = { items: allPosts };
    const jsonStr = JSON.stringify(finalObj, null, 2);
    
    const outDiv = document.getElementById('output');
    const outText = document.getElementById('jsonOutput');
    outDiv.style.display = 'block';
    outText.value = jsonStr;

    // è¤‡è£½åˆ°å‰ªè²¼ç°¿
    navigator.clipboard.writeText(jsonStr).then(() => {
      const tip = document.getElementById('copyTip');
      tip.style.display = 'block';
      setTimeout(() => tip.style.display='none', 5000);
      alert('ç¨‹å¼ç¢¼å·²è¤‡è£½ï¼\n\nç¾åœ¨è«‹å» GitHubï¼Œæ‰“é–‹ assets/js/posts.jsonï¼Œ\næŠŠå…§å®¹ã€Œå…¨éƒ¨åˆªé™¤ã€ï¼Œç„¶å¾Œã€Œè²¼ä¸Šã€æ–°çš„ã€‚');
    }).catch(err => {
      alert('è‡ªå‹•è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ä¸‹æ–¹çš„ç¨‹å¼ç¢¼æ¡†æ¡†ã€‚');
    });
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
