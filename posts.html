<!doctype html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>æ–‡ç«  | æˆ‘çš„ç¶²ç«™</title>
  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <meta name="description" content="æˆ‘çš„æ–‡ç« èˆ‡å°ˆæ¡ˆç´€éŒ„"/>
  <style>
    /* å·¥å…·åˆ— */
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0 20px}
    .toolbar .fld{display:flex;align-items:center;gap:6px}
    .toolbar input[type="text"]{min-width:260px;padding:8px 10px;border:1px solid #334155;border-radius:8px;background:transparent;color:inherit}
    .toolbar select,.toolbar input[type="date"]{padding:8px 10px;border:1px solid #334155;border-radius:8px;background:transparent;color:inherit}
    .toolbar .help{opacity:.7;font-size:.85rem}

    /* å¡ç‰‡/æŒ‰éˆ•ï¼ˆæ‰¿è¥²ä½ çš„é¢¨æ ¼ï¼‰ */
    .btn.sm{padding:4px 10px;font-size:.85rem;border-radius:6px;border:1px solid #64748b;text-decoration:none}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="container wrap">
      <a class="brand" href="index.html">
        <img src="assets/img/favicon.svg" alt="logo"/>
        <b>æˆ‘çš„ç¶²ç«™</b>
      </a>
      <div class="right">
        <a href="index.html#about">é—œæ–¼</a>
        <a href="index.html#projects">å°ˆæ¡ˆ</a>
        <a href="index.html#gallery">ç›¸ç°¿</a>
        <a href="posts.html">æ–‡ç« </a>
        <a href="index.html#contact">è¯çµ¡</a>
        <button id="themeToggle" aria-label="åˆ‡æ›ä¸»é¡Œ">ğŸŒ—</button>
      </div>
    </div>
  </nav>

  <main class="container section">
    <h1 id="pageTitle" style="margin:0 0 12px">æ–‡ç« </h1>

    <!-- æœå°‹ + é€²éšç¯©é¸å·¥å…·åˆ— -->
    <div id="toolbar" class="toolbar">
      <div class="fld">
        <input id="q" type="text" placeholder="æœå°‹æ¨™é¡Œï¼å…§æ–‡ï¼åœ°é»ï¼å¿ƒæƒ…â€¦ï¼ˆå³æ™‚ç¯©é¸ï¼‰"/>
      </div>
      <div class="fld">
        <label for="place">åœ°é»</label>
        <select id="place"><option value="">å…¨éƒ¨</option></select>
      </div>
      <div class="fld">
        <label for="feeling">å¿ƒæƒ…</label>
        <select id="feeling"><option value="">å…¨éƒ¨</option></select>
      </div>
      <div class="fld">
        <label for="from">å¾</label>
        <input id="from" type="date"/>
      </div>
      <div class="fld">
        <label for="to">åˆ°</label>
        <input id="to" type="date"/>
      </div>
      <div class="fld">
        <label for="sort">æ’åº</label>
        <select id="sort">
          <option value="desc">æ–° â†’ èˆŠ</option>
          <option value="asc">èˆŠ â†’ æ–°</option>
        </select>
      </div>
      <span class="help">æç¤ºï¼šè¼¸å…¥é—œéµå­—æˆ–èª¿æ•´æ¢ä»¶ï¼Œåˆ—è¡¨æœƒå³æ™‚æ›´æ–°ã€‚</span>
    </div>

    <div id="list" class="grid"></div>
    <hr class="sep"/>
    <article id="viewer" class="card" style="display:none"></article>
  </main>

  <script>
  // ===== å°å·¥å…· =====
  const strip = (s='') => s.toString().replace(/<[^>]+>/g,'');
  const fmtDate = s => {
    const d = new Date(s);
    return isNaN(d) ? s : d.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'});
  };
  const badge = t => `<span class="badge">${t}</span>`;
  const debounce = (fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

  // ===== åˆ—è¡¨ =====
  function renderList(items){
    const list = document.getElementById('list');
    if(!items.length){ list.innerHTML = '<p style="opacity:.8">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ–‡ç« ã€‚</p>'; return; }
    list.innerHTML = items.map(p=>{
      const title = p.title || `${fmtDate(p.date)} - ${p.place || ''}`;
      const previewSrc = strip(p.html || p.message || '').slice(0,110);
      const preview = previewSrc + (previewSrc.length>=110?'â€¦':'');
      return `
        <article class="card">
          <h3 style="margin:0">${title}</h3>
          <div style="display:flex; gap:8px; align-items:center; margin:6px 0 10px">
            <small style="opacity:.8">${fmtDate(p.date)}</small>
            <span>â€¢</span>
            ${p.place ? badge(p.place) : ''}
            ${p.feeling ? badge(p.feeling) : ''}
          </div>
          <p style="margin:0 0 12px; opacity:.95">${preview}</p>
          <p><a class="btn" href="posts.html#${encodeURIComponent(p.id)}">é–±è®€å…¨æ–‡</a></p>
        </article>
      `;
    }).join('');
  }

  // ===== å…§é  =====
  function renderViewer(p){
    const v = document.getElementById('viewer');
    v.style.display = 'block';
    const title = p.title || `${fmtDate(p.date)} - ${p.place || ''}`;
    document.getElementById('pageTitle').textContent = title;
    document.title = `${title}ï½œæˆ‘çš„ç¶²ç«™`;

    const fbBtn = p.fbURL ? `<p><a class="btn sm" href="${p.fbURL}" target="_blank" rel="noopener">åœ¨ Facebook æŸ¥çœ‹ â†—</a></p>` : '';

    v.innerHTML = `
      <p><a class="btn sm" href="posts.html">â† è¿”å›åˆ—è¡¨</a></p>
      <h2 style="margin:0 0 12px">${title}</h2>
      <div style="display:flex; gap:8px; align-items:center; margin:0 0 14px">
        <small style="opacity:.8">${fmtDate(p.date)}</small>
        <span>â€¢</span>
        ${p.place ? badge(p.place) : ''}
        ${p.feeling ? badge(p.feeling) : ''}
      </div>
      ${fbBtn}
      <div>${p.html || ''}</div>
    `;
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // ===== æ¨¡å¼åˆ‡æ› =====
  function showViewMode(){
    document.getElementById('toolbar').style.display = 'none';
    document.getElementById('list').style.display = 'none';
    document.getElementById('viewer').style.display = 'block';
  }
  function showListMode(){
    document.getElementById('toolbar').style.display = 'flex';
    document.getElementById('list').style.display = 'grid';
    document.getElementById('viewer').style.display = 'none';
    document.getElementById('pageTitle').textContent = 'æ–‡ç« ';
    document.title = 'æ–‡ç« ï½œæˆ‘çš„ç¶²ç«™';
  }

  // ===== å…¨åŸŸè³‡æ–™èˆ‡ç‹€æ…‹ =====
  let ALL = [];            // åŸå§‹è³‡æ–™
  let state = { q:'', place:'', feeling:'', from:'', to:'', sort:'desc' };

  function applyFilters(){
    // ä¾†æºè³‡æ–™
    let arr = ALL.slice();

    // æ–‡å­—æœå°‹
    if(state.q){
      const q = state.q.toLowerCase();
      arr = arr.filter(p=>{
        const hay = [
          p.title || '',
          strip(p.html || p.message || ''),
          p.place || '',
          p.feeling || ''
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }

    // åœ°é» / å¿ƒæƒ…
    if(state.place)  arr = arr.filter(p => (p.place||'')  === state.place);
    if(state.feeling)arr = arr.filter(p => (p.feeling||'')=== state.feeling);

    // æ—¥æœŸå€é–“ï¼ˆå«ç«¯é»ï¼‰
    if(state.from){
      arr = arr.filter(p => (p.date||'') >= state.from);
    }
    if(state.to){
      arr = arr.filter(p => (p.date||'') <= state.to);
    }

    // æ’åº
    arr.sort((a,b)=> state.sort==='desc' ? (a.date<b.date?1:-1) : (a.date>b.date?1:-1));

    renderList(arr);
  }

  // å»ºç«‹å·¥å…·åˆ—é¸å–®
  function buildToolbarOptions(){
    const places   = [...new Set(ALL.map(p=>p.place).filter(Boolean))].sort();
    const feelings = [...new Set(ALL.map(p=>p.feeling).filter(Boolean))].sort();
    const placeSel   = document.getElementById('place');
    const feelingSel = document.getElementById('feeling');
    placeSel.innerHTML   = `<option value="">å…¨éƒ¨</option>${places.map(v=>`<option>${v}</option>`).join('')}`;
    feelingSel.innerHTML = `<option value="">å…¨éƒ¨</option>${feelings.map(v=>`<option>${v}</option>`).join('')}`;
  }

  // ç¶å®šäº‹ä»¶
  function bindToolbar(){
    const $ = id => document.getElementById(id);
    const on = (el,ev,fn)=> el.addEventListener(ev,fn);

    on($('q')      ,'input', debounce(e=>{ state.q = e.target.value.trim(); applyFilters(); },200));
    on($('place')  ,'change', e=>{ state.place   = e.target.value; applyFilters(); });
    on($('feeling'),'change', e=>{ state.feeling = e.target.value; applyFilters(); });
    on($('from')   ,'change', e=>{ state.from    = e.target.value; applyFilters(); });
    on($('to')     ,'change', e=>{ state.to      = e.target.value; applyFilters(); });
    on($('sort')   ,'change', e=>{ state.sort    = e.target.value; applyFilters(); });
  }

  // ===== å•Ÿå‹• =====
  async function boot(){
    const listEl = document.getElementById('list');
    listEl.innerHTML = 'è¼‰å…¥ä¸­â€¦';

    async function fetchJSON(path){
      const res = await fetch(path + '?v=' + Date.now(), { cache:'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status + ' @ ' + path);
      return res.json();
    }

    // å˜—è©¦å…©å€‹è·¯å¾‘è¼‰å…¥
    let raw;
    try { raw = await fetchJSON('assets/js/posts.json'); }
    catch(e1){
      try { raw = await fetchJSON('Bruce/assets/js/posts.json'); }
      catch(e2){ listEl.innerHTML = '<p>âŒ è®€å–å¤±æ•—ï¼šè«‹ç¢ºèª posts.json è·¯å¾‘ã€‚</p>'; console.error(e1,e2); return; }
    }

    // æ ¼å¼è½‰æ›
    if (Array.isArray(raw)) {
      // ä½ è‡ªè¨‚çš„ posts.jsonï¼ˆå»ºè­°å­—æ®µï¼šid/title/date/place/feeling/html/fbURLï¼‰
      ALL = raw.slice().map(p=>({
        id:String(p.id),
        title:p.title||'',
        date:p.date||'',
        place:p.place||'',
        feeling:p.feeling||'',
        html:p.html||'',
        message:p.message||'',
        fbURL:p.fbURL||p.url||''
      }));
    } else if (raw && Array.isArray(raw.items)) {
      // å…¼å®¹ {items:[...]}ï¼ˆFacebook åŒ¯å…¥æ ¼å¼ï¼‰
      ALL = raw.items.map(p=>{
        const date = (p.time||'').slice(0,10);
        const html =
          (p.image ? `<p><img src="${p.image}" alt="" style="max-width:100%;border-radius:12px"/></p>` : '') +
          `<p style="opacity:.85">æ™‚é–“ï¼š${new Date(p.time).toLocaleString('zh-TW',{hour12:false})}${p.place ? 'ï½œåœ°é»ï¼š'+p.place : ''}${p.feeling ? 'ï½œå¿ƒæƒ…ï¼š'+p.feeling : ''}</p>` +
          `<div>${(p.message || '').replace(/\n/g,'<br>')}</div>`;
        return {
          id:String(p.id),
          title: p.title || `${fmtDate(date)} - ${p.place||''}`,
          date,
          place: p.place||'',
          feeling: p.feeling||'',
          html,
          message:p.message||'',
          fbURL: p.url||''
        };
      });
    } else {
      listEl.innerHTML = '<p>âš ï¸ posts.json æ ¼å¼éŒ¯èª¤ã€‚</p>';
      return;
    }

    // é è¨­æ’åºï¼šæ–°â†’èˆŠ
    ALL.sort((a,b)=> (a.date<b.date?1:-1));

    // å·¥å…·åˆ—
    buildToolbarOptions();
    bindToolbar();

    // åˆæ¬¡æ¸²æŸ“
    applyFilters();

    // è·¯ç”±ï¼ˆå…§é ï¼‰
    function route(){
      const rawHash = location.hash.slice(1);
      if(!rawHash){ showListMode(); return; }
      const id = decodeURIComponent(rawHash);
      const p = ALL.find(x=> String(x.id) === id);
      if(p){ showViewMode(); renderViewer(p); }
      else { showListMode(); }
    }
    route();
    window.addEventListener('hashchange', route);

    // ä¸»é¡Œåˆ‡æ›
    const t = localStorage.getItem('theme');
    if(t) document.documentElement.dataset.theme = t;
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const dark = document.documentElement.dataset.theme !== 'light';
      document.documentElement.dataset.theme = dark ? 'light' : 'dark';
      localStorage.setItem('theme', document.documentElement.dataset.theme);
    });
  }

  document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
