<!doctype html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>文章 | 我的網站</title>
  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <meta name="description" content="我的文章與專案紀錄"/>

  <style>
    :root {
      --bg-dark:#0f172a;
      --bg-light:#f8fafc;
      --text-dark:#f1f5f9;
      --text-light:#1e293b;
      --muted-dark:#94a3b8;
      --muted-light:#475569;
      --border-dark:#334155;
      --border-light:#d1d5db;
      --accent-dark:#2563eb;
      --accent-light:#3b82f6;
    }

    /* ====== Base ====== */
    body {
      background:var(--bg-dark);
      color:var(--text-dark);
      transition:background .3s,color .3s;
    }

    [data-theme="light"] body {
      background:var(--bg-light);
      color:var(--text-light);
    }

    .sep { border:none; border-top:1px solid var(--border-dark); margin:32px 0; }
    [data-theme="light"] .sep { border-color:var(--border-light); }

    /* ===== Toolbar ===== */
    .toolbar {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:12px 0 20px;
      color:inherit;
    }
    .toolbar .fld { display:flex; align-items:center; gap:6px; }
    .toolbar label { font-weight:500; opacity:.9; }
    .toolbar input[type="text"],
    .toolbar select,
    .toolbar input[type="date"] {
      padding:8px 10px;
      border:1px solid var(--border-dark);
      border-radius:8px;
      background-color:#1e293b;
      color:var(--text-dark);
    }
    [data-theme="light"] .toolbar input[type="text"],
    [data-theme="light"] .toolbar select,
    [data-theme="light"] .toolbar input[type="date"] {
      background-color:#fff;
      border:1px solid var(--border-light);
      color:var(--text-light);
    }
    .toolbar input::placeholder { color:var(--muted-dark); }
    [data-theme="light"] .toolbar input::placeholder { color:var(--muted-light); }
    .toolbar .help { opacity:.8; font-size:.85rem; color:var(--muted-dark); }
    [data-theme="light"] .toolbar .help { color:var(--muted-light); }

    /* ===== Card ===== */
    .card {
      background:var(--bg-dark);
      border:1px solid var(--border-dark);
      border-radius:12px;
      padding:16px;
      color:var(--text-dark);
      line-height:1.7;
      transition:background .3s,border .3s,box-shadow .2s;
    }
    [data-theme="light"] .card {
      background:#fff;
      border:1px solid var(--border-light);
      color:var(--text-light);
    }
    [data-theme="light"] .card:hover {
      box-shadow:0 2px 6px rgba(0,0,0,.08);
    }
    .card h3 { font-size:1.2rem; margin-bottom:6px; color:inherit; }
    .card small { color:var(--muted-dark); }
    [data-theme="light"] .card small { color:var(--muted-light); }

    /* ===== Badge ===== */
    .badge {
      background:var(--accent-dark);
      color:#e0f2fe;
      border-radius:6px;
      padding:2px 8px;
      font-size:.8rem;
    }
    [data-theme="light"] .badge {
      background:var(--accent-light);
      color:#fff;
    }

    /* ===== Buttons ===== */
    .btn {
      background:var(--accent-dark);
      color:#fff;
      border:none;
      border-radius:8px;
      padding:6px 14px;
      text-decoration:none;
      transition:.2s;
    }
    .btn:hover { background:#1d4ed8; }
    [data-theme="light"] .btn {
      background:var(--accent-light);
      color:#fff;
    }
    [data-theme="light"] .btn:hover {
      background:#2563eb;
    }
    .btn.sm {
      padding:4px 10px;
      font-size:.85rem;
      background:#334155;
      color:#f8fafc;
    }
    .btn.sm:hover { background:#475569; }
    [data-theme="light"] .btn.sm {
      background:#e2e8f0;
      color:#1e293b;
    }
    [data-theme="light"] .btn.sm:hover {
      background:#cbd5e1;
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="container wrap">
      <a class="brand" href="index.html">
        <img src="assets/img/favicon.svg" alt="logo"/>
        <b>我的網站</b>
      </a>
      <div class="right">
        <a href="index.html#about">關於</a>
        <a href="index.html#projects">專案</a>
        <a href="index.html#gallery">相簿</a>
        <a href="posts.html">文章</a>
        <a href="index.html#contact">聯絡</a>
        <button id="themeToggle" aria-label="切換主題">🌗</button>
      </div>
    </div>
  </nav>

  <main class="container section">
    <h1 id="pageTitle" style="margin:0 0 12px">文章</h1>

    <!-- 工具列：搜尋 + 篩選 -->
    <div id="toolbar" class="toolbar">
      <div class="fld">
        <input id="q" type="text" placeholder="搜尋標題／內文／地點／心情…（即時篩選）"/>
      </div>
      <div class="fld">
        <label for="place">地點</label>
        <select id="place"><option value="">全部</option></select>
      </div>
      <div class="fld">
        <label for="feeling">心情</label>
        <select id="feeling"><option value="">全部</option></select>
      </div>
      <div class="fld">
        <label for="from">從</label>
        <input id="from" type="date"/>
      </div>
      <div class="fld">
        <label for="to">到</label>
        <input id="to" type="date"/>
      </div>
      <div class="fld">
        <label for="sort">排序</label>
        <select id="sort">
          <option value="desc">新 → 舊</option>
          <option value="asc">舊 → 新</option>
        </select>
      </div>
      <span class="help">提示：輸入關鍵字或調整條件，列表會即時更新。</span>
    </div>

    <div id="list" class="grid"></div>
    <hr class="sep"/>
    <article id="viewer" class="card" style="display:none"></article>
  </main>

  <script>
  const strip = s => s?.replace(/<[^>]+>/g,'') || '';
  const fmtDate = s => {
    const d = new Date(s);
    return isNaN(d) ? s : d.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'});
  };
  const badge = t => `<span class="badge">${t}</span>`;
  const debounce = (fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

  function renderList(items){
    const list = document.getElementById('list');
    if(!items.length){ list.innerHTML='<p style="opacity:.8">找不到符合條件的文章。</p>'; return; }
    list.innerHTML = items.map(p=>{
      const title = p.title || `${fmtDate(p.date)} - ${p.place||''}`;
      const preview = strip(p.html||p.message||'').slice(0,110) + '…';
      return `
        <article class="card">
          <h3>${title}</h3>
          <div style="display:flex; gap:8px; align-items:center; margin:6px 0 10px">
            <small>${fmtDate(p.date)}</small>
            <span>•</span>
            ${p.place?badge(p.place):''}
            ${p.feeling?badge(p.feeling):''}
          </div>
          <p style="opacity:.95">${preview}</p>
          <p><a class="btn" href="posts.html#${encodeURIComponent(p.id)}">閱讀全文</a></p>
        </article>`;
    }).join('');
  }

  function renderViewer(p){
    const v=document.getElementById('viewer');
    v.style.display='block';
    const title=p.title||`${fmtDate(p.date)} - ${p.place||''}`;
    document.getElementById('pageTitle').textContent=title;
    document.title=`${title}｜我的網站`;
    const fbBtn=p.fbURL?`<p><a class="btn sm" href="${p.fbURL}" target="_blank">在 Facebook 查看 ↗</a></p>`:'';
    v.innerHTML=`
      <p><a class="btn sm" href="posts.html">← 返回列表</a></p>
      <h2>${title}</h2>
      <div style="display:flex; gap:8px; align-items:center; margin:0 0 14px">
        <small>${fmtDate(p.date)}</small><span>•</span>
        ${p.place?badge(p.place):''}
        ${p.feeling?badge(p.feeling):''}
      </div>
      ${fbBtn}
      <div>${p.html||''}</div>`;
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function showViewMode(){
    document.getElementById('toolbar').style.display='none';
    document.getElementById('list').style.display='none';
    document.getElementById('viewer').style.display='block';
  }
  function showListMode(){
    document.getElementById('toolbar').style.display='flex';
    document.getElementById('list').style.display='grid';
    document.getElementById('viewer').style.display='none';
    document.getElementById('pageTitle').textContent='文章';
    document.title='文章｜我的網站';
  }

  let ALL=[],state={q:'',place:'',feeling:'',from:'',to:'',sort:'desc'};

  function applyFilters(){
    let arr=ALL.slice();
    if(state.q){
      const q=state.q.toLowerCase();
      arr=arr.filter(p=>{
        const hay=[p.title,strip(p.html||p.message||''),p.place,p.feeling].join(' ').toLowerCase();
        return hay.includes(q);
      });
    }
    if(state.place)arr=arr.filter(p=>(p.place||'')===state.place);
    if(state.feeling)arr=arr.filter(p=>(p.feeling||'')===state.feeling);
    if(state.from)arr=arr.filter(p=>(p.date||'')>=state.from);
    if(state.to)arr=arr.filter(p=>(p.date||'')<=state.to);
    arr.sort((a,b)=>state.sort==='desc'?(a.date<b.date?1:-1):(a.date>b.date?1:-1));
    renderList(arr);
  }

  function buildToolbarOptions(){
    const places=[...new Set(ALL.map(p=>p.place).filter(Boolean))].sort();
    const feelings=[...new Set(ALL.map(p=>p.feeling).filter(Boolean))].sort();
    const placeSel=document.getElementById('place');
    const feelingSel=document.getElementById('feeling');
    placeSel.innerHTML=`<option value="">全部</option>${places.map(v=>`<option>${v}</option>`).join('')}`;
    feelingSel.innerHTML=`<option value="">全部</option>${feelings.map(v=>`<option>${v}</option>`).join('')}`;
  }

  function bindToolbar(){
    const $=id=>document.getElementById(id);
    const on=(el,ev,fn)=>el.addEventListener(ev,fn);
    on($('q'),'input',debounce(e=>{state.q=e.target.value.trim();applyFilters();},200));
    on($('place'),'change',e=>{state.place=e.target.value;applyFilters();});
    on($('feeling'),'change',e=>{state.feeling=e.target.value;applyFilters();});
    on($('from'),'change',e=>{state.from=e.target.value;applyFilters();});
    on($('to'),'change',e=>{state.to=e.target.value;applyFilters();});
    on($('sort'),'change',e=>{state.sort=e.target.value;applyFilters();});
  }

  async function boot(){
    const listEl=document.getElementById('list');
    listEl.innerHTML='載入中…';
    async function fetchJSON(path){
      const res=await fetch(path+'?v='+Date.now(),{cache:'no-store'});
      if(!res.ok)throw new Error('HTTP '+res.status);
      return res.json();
    }
    let raw;
    try{raw=await fetchJSON('assets/js/posts.json');}
    catch{try{raw=await fetchJSON('Bruce/assets/js/posts.json');}
      catch(e){listEl.innerHTML='<p>❌ 讀取失敗。</p>';return;}
    }
    if(Array.isArray(raw)){
      ALL=raw.map(p=>({id:String(p.id),title:p.title||'',date:p.date||'',place:p.place||'',feeling:p.feeling||'',html:p.html||'',message:p.message||'',fbURL:p.fbURL||p.url||''}));
    }else if(raw&&Array.isArray(raw.items)){
      ALL=raw.items.map(p=>{
        const date=(p.time||'').slice(0,10);
        const html=(p.image?`<p><img src="${p.image}" alt="" style="max-width:100%;border-radius:12px"/></p>`:'')+
          `<p style="opacity:.85">時間：${new Date(p.time).toLocaleString('zh-TW',{hour12:false})}${p.place?'｜地點：'+p.place:''}${p.feeling?'｜心情：'+p.feeling:''}</p>`+
          `<div>${(p.message||'').replace(/\n/g,'<br>')}</div>`;
        return{id:String(p.id),title:p.title||`${fmtDate(date)} - ${p.place||''}`,date,place:p.place||'',feeling:p.feeling||'',html,message:p.message||'',fbURL:p.url||''};
      });
    }
    ALL.sort((a,b)=>(a.date<b.date?1:-1));
    buildToolbarOptions();bindToolbar();applyFilters();
    function route(){
      const h=location.hash.slice(1);
      if(!h){showListMode();return;}
      const p=ALL.find(x=>String(x.id)===decodeURIComponent(h));
      p? (showViewMode(),renderViewer(p)) : showListMode();
    }
    route();window.addEventListener('hashchange',route);
    const t=localStorage.getItem('theme');
    if(t)document.documentElement.dataset.theme=t;
    document.getElementById('themeToggle').addEventListener('click',()=>{
      const dark=document.documentElement.dataset.theme!=='light';
      document.documentElement.dataset.theme=dark?'light':'dark';
      localStorage.setItem('theme',document.documentElement.dataset.theme);
    });
  }
  document.addEventListener('DOMContentLoaded',boot);
  </script>
</body>
</html>
