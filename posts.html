<!doctype html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>æ–‡ç«  | æˆ‘çš„ç¶²ç«™</title>
  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <meta name="description" content="æˆ‘çš„æ–‡ç« èˆ‡å°ˆæ¡ˆç´€éŒ„"/>
  <style>
    .all-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .all-list .item{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:10px 12px;border:1px solid #334155;border-radius:10px}
    .all-list .left{min-width:0}
    .all-list .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .all-list .meta{opacity:.75;font-size:.85rem}
    .btn.sm{padding:4px 10px;font-size:.85rem;border-radius:6px;border:1px solid #64748b;text-decoration:none}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="container wrap">
      <a class="brand" href="index.html">
        <img src="assets/img/favicon.svg" alt="logo"/>
        <b>æˆ‘çš„ç¶²ç«™</b>
      </a>
      <div class="right">
        <a href="index.html#about">é—œæ–¼</a>
        <a href="index.html#projects">å°ˆæ¡ˆ</a>
        <a href="index.html#gallery">ç›¸ç°¿</a>
        <a href="posts.html">æ–‡ç« </a>
        <a href="index.html#contact">è¯çµ¡</a>
        <button id="themeToggle" aria-label="åˆ‡æ›ä¸»é¡Œ">ğŸŒ—</button>
      </div>
    </div>
  </nav>

  <main class="container section">
    <h1 style="margin:0 0 12px">æ–‡ç« </h1>
    <div id="filters" style="display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 20px"></div>
    <div id="list" class="grid"></div>
    <hr class="sep"/>
    <article id="viewer" class="card" style="display:none"></article>
  </main>

  <script>
  // -------- å·¥å…· --------
  function formatDate(s){
    const d = new Date(s + 'T00:00:00');
    return isNaN(d) ? s : d.toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
  }
  function tagBadge(t){ return `<span class="badge">${t}</span>` }

  // -------- åˆ—è¡¨ --------
  function renderList(items){
    const list = document.getElementById('list');
    list.innerHTML = items.map(p => `
      <article class="card">
        <h3 style="margin:0">${p.title}</h3>
        <div style="display:flex; gap:8px; align-items:center; margin:6px 0 10px">
          <small style="opacity:.8">${formatDate(p.date)}</small>
          <span>â€¢</span>
          ${(p.tags||[]).map(tagBadge).join(' ')}
        </div>
        <p style="margin:0 0 12px; opacity:.95">${(p.html||'').replace(/<[^>]+>/g,'').slice(0,110)}...</p>
        <p>
          <a class="btn" href="posts.html#${p.id}">é–±è®€å…¨æ–‡</a>
          ${p.fbURL ? ` <a class="btn" href="${p.fbURL}" target="_blank" rel="noopener">Facebook é€£çµ â†—</a>` : ''}
        </p>
      </article>
    `).join('');
  }

  // -------- ç¯©é¸ --------
  function renderFilters(items){
    const set = new Set(); items.forEach(p => (p.tags||[]).forEach(t=>set.add(t)));
    const all = Array.from(set).sort();
    const filters = document.getElementById('filters');
    filters.innerHTML = ['å…¨éƒ¨', ...all].map(t=>`<a class="btn" href="#" data-filter="${t}">${t}</a>`).join('');
    filters.querySelectorAll('a').forEach(a=>a.addEventListener('click', e=>{
      e.preventDefault();
      const f = a.dataset.filter;
      const filtered = f==='å…¨éƒ¨' ? window.__posts : window.__posts.filter(p=>(p.tags||[]).includes(f));
      renderList(filtered);
      history.replaceState(null, '', 'posts.html');
      document.getElementById('viewer').style.display = 'none';
    }));
  }

  // -------- è©³é–±ï¼ˆé¡¯ç¤º FB é€£çµ + æ‰€æœ‰æ–‡ç« æ¸…å–®ï¼‰--------
  function renderViewer(p){
    const v = document.getElementById('viewer');
    v.style.display = 'block';

    // åº•ä¸‹ã€Œæ‰€æœ‰æ–‡ç« ã€æ¸…å–®
    const allHTML = window.__posts.map(x => `
      <div class="item">
        <div class="left">
          <div class="title">${x.title}</div>
          <div class="meta">${formatDate(x.date)}ã€€${(x.tags||[]).slice(0,3).join(' / ')}</div>
        </div>
        <div class="right">
          <a class="btn sm" href="posts.html#${x.id}">é–±è®€</a>
          ${x.fbURL ? ` <a class="btn sm" href="${x.fbURL}" target="_blank" rel="noopener" title="åœ¨ Facebook æŸ¥çœ‹">FB â†—</a>` : ''}
        </div>
      </div>
    `).join('');

    v.innerHTML = `
      <h2 style="margin:0 0 12px">${p.title}</h2>
      <div style="display:flex; gap:8px; align-items:center; margin:0 0 14px">
        <small style="opacity:.8">${formatDate(p.date)}</small>
        <span>â€¢</span>
        ${(p.tags||[]).map(tagBadge).join(' ')}
      </div>
      ${p.fbURL ? `<p><a class="btn" href="${p.fbURL}" target="_blank" rel="noopener">åœ¨ Facebook æŸ¥çœ‹ â†—</a></p>` : ''}
      <div>${p.html||''}</div>

      <h3 style="margin:22px 0 10px">æ‰€æœ‰æ–‡ç« </h3>
      <div class="all-list">${allHTML}</div>

      <p style="margin-top:16px"><a class="btn" href="posts.html">â† è¿”å›åˆ—è¡¨</a></p>
    `;
    window.scrollTo({top:0, behavior:'smooth'});
  }

  // -------- ä¸»ç¨‹å¼ï¼šç›¸å®¹å…©ç¨® posts.json --------
  async function boot(){
    const listEl = document.getElementById('list');
    const viewerEl = document.getElementById('viewer');
    listEl.innerHTML = 'è¼‰å…¥ä¸­â€¦';

    async function fetchJSON(path){
      const res = await fetch(path + '?v=' + Date.now(), { cache:'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status + ' @ ' + path);
      return res.json();
    }

    let raw;
    try {
      raw = await fetchJSON('assets/js/posts.json');
    } catch(e1){
      try {
        raw = await fetchJSON('Bruce/assets/js/posts.json');
      } catch(e2){
        console.error(e1, e2);
        listEl.innerHTML = '<p>âŒ è®€å–å¤±æ•—ï¼šæ‰¾ä¸åˆ° <code>assets/js/posts.json</code> æˆ– <code>Bruce/assets/js/posts.json</code>ã€‚</p>';
        return;
      }
    }

    // â‘  éƒ¨è½æ ¼æ ¼å¼ï¼š[{ id,title,date,tags,html, fbURL? }]
    if (Array.isArray(raw)) {
      window.__posts = raw.slice().map(p=>({ ...p, fbURL: p.fbURL || null })).sort((a,b)=> (a.date<b.date?1:-1));
    }
    // â‘¡ Facebook æ ¼å¼ï¼š{ items:[{ id,time,message,image,url,feeling,place }] }
    else if (raw && Array.isArray(raw.items)) {
      const converted = raw.items.map(p=>{
        const date = (p.time||'').slice(0,10);
        const title = (p.message||'').split('\n')[0].slice(0,30) || 'Facebook è²¼æ–‡';
        const tags = ['Facebook']
          .concat(p.place ? [p.place] : [])
          .concat(p.feeling ? [p.feeling] : []);
        const timeText = p.time ? new Date(p.time).toLocaleString('zh-TW',{hour12:false}) : '';
        const html =
          (p.image ? `<p><img src="${p.image}" alt="" style="max-width:100%;border-radius:12px"/></p>` : '') +
          `<p style="opacity:.85">æ™‚é–“ï¼š${timeText}${p.place ? 'ï½œåœ°é»ï¼š'+p.place : ''}${p.feeling ? 'ï½œå¿ƒæƒ…ï¼š'+p.feeling : ''}</p>` +
          `<p>${(p.message||'').replace(/\n/g,'<br>')}</p>` +
          (p.url ? `<p><a class="btn" href="${p.url}" target="_blank" rel="noopener">åœ¨ Facebook æŸ¥çœ‹ â†—</a></p>` : '');
        return { id:p.id, title, date, tags, html, fbURL: p.url || null };
      });
      window.__posts = converted.sort((a,b)=> (a.date<b.date?1:-1));
    }
    else {
      listEl.innerHTML = '<p>âš ï¸ posts.json æ ¼å¼éŒ¯èª¤ï¼ˆéœ€ç‚ºé™£åˆ—æˆ– {items:[...]}ï¼‰ã€‚</p>';
      console.error('æ ¼å¼éŒ¯èª¤ï¼š', raw);
      return;
    }

    renderFilters(window.__posts);
    renderList(window.__posts);

    function route(){
      const id = location.hash.slice(1);
      if(!id){ viewerEl.style.display='none'; return; }
      const p = window.__posts.find(x=>x.id===id);
      if(p) renderViewer(p);
    }
    route();
    window.addEventListener('hashchange', route);

    // ä¸»é¡Œåˆ‡æ›ï¼ˆä¿ç•™ï¼‰
    const t = localStorage.getItem('theme'); if(t) document.documentElement.dataset.theme = t;
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const dark = document.documentElement.dataset.theme !== 'light';
      document.documentElement.dataset.theme = dark ? 'light' : 'dark';
      localStorage.setItem('theme', document.documentElement.dataset.theme);
    });
  }
  document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
