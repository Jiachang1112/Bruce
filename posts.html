<!doctype html>
<html lang="zh-Hant" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>文章 | 我的網站</title>
  <link rel="icon" href="assets/img/favicon.svg" type="image/svg+xml"/>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <meta name="description" content="我的文章與專案紀錄"/>
</head>
<body>
  <nav class="nav">
    <div class="container wrap">
      <a class="brand" href="index.html">
        <img src="assets/img/favicon.svg" alt="logo"/>
        <b>我的網站</b>
      </a>
      <div class="right">
        <a href="index.html#about">關於</a>
        <a href="index.html#projects">專案</a>
        <a href="index.html#gallery">相簿</a>
        <a href="posts.html">文章</a>
        <a href="index.html#contact">聯絡</a>
        <button id="themeToggle" aria-label="切換主題">🌗</button>
      </div>
    </div>
  </nav>

  <main class="container section">
    <h1 style="margin:0 0 12px">文章</h1>
    <div id="filters" style="display:flex; gap:8px; flex-wrap:wrap; margin:12px 0 20px"></div>
    <div id="list" class="grid"></div>
    <hr class="sep"/>
    <article id="viewer" class="card" style="display:none"></article>
  </main>

  <script>
  function formatDate(s){
    const d = new Date(s + 'T00:00:00');
    if (!isNaN(d)) return d.toLocaleDateString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit'});
    return s;
  }
  function tagBadge(t){ return `<span class="badge">${t}</span>` }
  function renderList(items){
    const list = document.getElementById('list');
    list.innerHTML = items.map(p => `
      <article class="card">
        <h3 style="margin:0">${p.title}</h3>
        <div style="display:flex; gap:8px; align-items:center; margin:6px 0 10px">
          <small style="opacity:.8">${formatDate(p.date)}</small>
          <span>•</span>
          ${p.tags.map(tagBadge).join(' ')}
        </div>
        <p style="margin:0 0 12px; opacity:.95">${(p.html.replace(/<[^>]+>/g,'').slice(0,110))}...</p>
        <p><a class="btn" href="posts.html#${p.id}">閱讀全文</a></p>
      </article>
    `).join('');
  }
  function renderFilters(items){
    const set = new Set();
    items.forEach(p => (p.tags||[]).forEach(t=>set.add(t)));
    const filters = document.getElementById('filters');
    const all = Array.from(set).sort();
    filters.innerHTML = ['全部', ...all].map(t=>`<a class="btn" href="#" data-filter="${t}">${t}</a>`).join('');
    filters.querySelectorAll('a').forEach(a=>a.addEventListener('click', e=>{
      e.preventDefault();
      const f = a.dataset.filter;
      const filtered = f==='全部' ? window.__posts : window.__posts.filter(p=>p.tags.includes(f));
      renderList(filtered);
      history.replaceState(null, '', 'posts.html');
      document.getElementById('viewer').style.display = 'none';
    }));
  }
  function renderViewer(p){
    const v = document.getElementById('viewer');
    v.style.display = 'block';
    v.innerHTML = `
      <h2 style="margin:0 0 12px">${p.title}</h2>
      <div style="display:flex; gap:8px; align-items:center; margin:0 0 14px">
        <small style="opacity:.8">${formatDate(p.date)}</small>
        <span>•</span>
        ${p.tags.map(tagBadge).join(' ')}
      </div>
      <div>${p.html}</div>
      <p style="margin-top:16px"><a class="btn" href="posts.html">← 返回列表</a></p>
    `;
    window.scrollTo({top:0, behavior:'smooth'});
  }
  async function boot(){
    const res = await fetch('assets/js/posts.json');
    const posts = await res.json();
    // sort by date desc
    posts.sort((a,b)=> (a.date<b.date?1:-1));
    window.__posts = posts;
    renderFilters(posts);
    renderList(posts);
    // route by hash
    const id = location.hash.slice(1);
    if(id){
      const p = posts.find(x=>x.id===id);
      if(p){ renderViewer(p); }
    }
    window.addEventListener('hashchange', ()=>{
      const id = location.hash.slice(1);
      if(!id){ document.getElementById('viewer').style.display = 'none'; return }
      const p = posts.find(x=>x.id===id);
      if(p){ renderViewer(p); }
    });
    // theme btn
    const t = localStorage.getItem('theme'); if(t) document.documentElement.dataset.theme = t;
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const dark = document.documentElement.dataset.theme !== 'light';
      document.documentElement.dataset.theme = dark ? 'light':'dark';
      localStorage.setItem('theme', document.documentElement.dataset.theme);
    });
  }
  document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>