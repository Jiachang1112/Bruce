<script>
async function boot(){
  const listEl = document.getElementById('list');
  const filtersEl = document.getElementById('filters');
  const viewerEl = document.getElementById('viewer');

  // ---- 1) 抓 JSON（避開快取＋雙路徑 fallback）----
  async function fetchJSON(path){
    const res = await fetch(path + '?v=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status + ' at ' + path);
    return res.json();
  }

  let data;
  try {
    data = await fetchJSON('assets/js/posts.json');
  } catch (e1) {
    try {
      data = await fetchJSON('Bruce/assets/js/posts.json');
    } catch (e2) {
      console.error(e1, e2);
      document.getElementById('list').innerHTML = '<p>讀取失敗：找不到 <code>assets/js/posts.json</code> 或 <code>Bruce/assets/js/posts.json</code>。</p>';
      return;
    }
  }

  // ---- 2) 正規化成陣列 ----
  let posts = Array.isArray(data) ? data : (data.items || []);
  if (!Array.isArray(posts)) {
    console.error('posts.json 內容不是陣列或 items 陣列：', data);
    listEl.innerHTML = '<p>posts.json 格式錯誤：需為陣列或 {items:[...]}</p>';
    return;
  }

  // ---- 3) 排序 & 渲染（保留你原本的 UI）----
  posts.sort((a,b)=> (a.date < b.date ? 1 : -1));
  window.__posts = posts;

  function formatDate(s){
    const d = new Date(s + 'T00:00:00');
    return isNaN(d) ? s : d.toLocaleDateString('zh-TW',{year:'numeric',month:'2-digit',day:'2-digit'});
  }
  function tagBadge(t){ return `<span class="badge">${t}</span>` }

  function renderList(items){
    listEl.innerHTML = items.map(p => `
      <article class="card">
        <h3 style="margin:0">${p.title}</h3>
        <div style="display:flex; gap:8px; align-items:center; margin:6px 0 10px">
          <small style="opacity:.8">${formatDate(p.date)}</small>
          <span>•</span>
          ${(p.tags||[]).map(tagBadge).join(' ')}
        </div>
        <p style="margin:0 0 12px; opacity:.95">${(p.html||'').replace(/<[^>]+>/g,'').slice(0,110)}...</p>
        <p><a class="btn" href="posts.html#${p.id}">閱讀全文</a></p>
      </article>
    `).join('');
  }

  function renderFilters(items){
    const set = new Set(); items.forEach(p => (p.tags||[]).forEach(t=>set.add(t)));
    const all = Array.from(set).sort();
    filtersEl.innerHTML = ['全部', ...all].map(t=>`<a class="btn" href="#" data-filter="${t}">${t}</a>`).join('');
    filtersEl.querySelectorAll('a').forEach(a=>a.addEventListener('click', e=>{
      e.preventDefault();
      const f = a.dataset.filter;
      const filtered = f==='全部' ? window.__posts : window.__posts.filter(p=>(p.tags||[]).includes(f));
      renderList(filtered);
      history.replaceState(null, '', 'posts.html');
      viewerEl.style.display = 'none';
    }));
  }

  function renderViewer(p){
    viewerEl.style.display = 'block';
    viewerEl.innerHTML = `
      <h2 style="margin:0 0 12px">${p.title}</h2>
      <div style="display:flex; gap:8px; align-items:center; margin:0 0 14px">
        <small style="opacity:.8">${formatDate(p.date)}</small>
        <span>•</span>
        ${(p.tags||[]).map(tagBadge).join(' ')}
      </div>
      <div>${p.html||''}</div>
      <p style="margin-top:16px"><a class="btn" href="posts.html">← 返回列表</a></p>
    `;
    window.scrollTo({top:0, behavior:'smooth'});
  }

  renderFilters(posts);
  renderList(posts);

  // hash 路由
  function route(){
    const id = location.hash.slice(1);
    if(!id){ viewerEl.style.display='none'; return; }
    const p = posts.find(x=>x.id===id);
    if(p) renderViewer(p);
  }
  route();
  window.addEventListener('hashchange', route);

  // 主題切換保留
  const t = localStorage.getItem('theme'); if(t) document.documentElement.dataset.theme = t;
  document.getElementById('themeToggle').addEventListener('click', ()=>{
    const dark = document.documentElement.dataset.theme !== 'light';
    document.documentElement.dataset.theme = dark ? 'light' : 'dark';
    localStorage.setItem('theme', document.documentElement.dataset.theme);
  });
}
document.addEventListener('DOMContentLoaded', boot);
</script>
